require('dotenv').config();
const { RPC_ENDPOINT, USDT_ADDRESS, FROM_BLOCK } = process.env;
const { providers, Contract, } = require('ethers');
const abi = require('../build/TetherToken.json').abi;



async function main() {
  const provider = new providers.JsonRpcProvider(RPC_ENDPOINT);
  const contract = new Contract(USDT_ADDRESS, abi, provider);

  const filter = contract.filters.NewPrivilegedContract(null);
  //console.log({ filter });

  let lastBlockNumbet = await provider.getBlockNumber();
  let fromBlock = parseInt(FROM_BLOCK);
  let toBlock = fromBlock + 1000000;
  if (toBlock > lastBlockNumbet) {
    toBlock = lastBlockNumbet - 1;
  }
  while (toBlock < lastBlockNumbet) {
    const res = await contract.queryFilter(
      'NewPrivilegedContract',
      fromBlock,
      toBlock
    );
    console.log(`${toBlock} / ${lastBlockNumbet}`);
    if (res.length > 0) {
      console.log(res);
    }

    fromBlock = toBlock;
    toBlock = fromBlock + 1000000;
    lastBlockNumbet = await provider.getBlockNumber();
    if (toBlock > lastBlockNumbet) {
      toBlock = lastBlockNumbet - 1;
    }
  }
}
main();